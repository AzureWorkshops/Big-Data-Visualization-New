<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Summarize data using HDInsight Spark - Big Data and Visualization</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="description" content="Azure Workshops" />
    <meta name="author" content="Marty Pittman">
    <link rel="icon" href="" type="image/x-icon">
    
    <!-- Font -->
    
    <!-- CSS -->
    <link href='../themes/azure/css/vs.css' rel='stylesheet' type='text/css'><link href='../themes/azure/css/theme.css' rel='stylesheet' type='text/css'><link href='../themes/azure/css/theme-white.min.css' rel='stylesheet' type='text/css'>
</head>
<body class="">

        <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-2 col-md-offset-1">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Azure Workshops</a>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <!--
                            <li><a href="about.html">About</a></li>
                            <li><a href="contact.html">Contact</a></li>
                            -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

<div id="content-wrapper" class="container-fluid">
    <div class="row hidden-print">
        <div class="col-md-10 col-md-offset-1 breadcrumbs">
            <a href="../index.html">Big Data and Visualization</a> / <a href="../Courseware/Build_a_ML_Model.html">Courseware</a> / <a href="../Courseware/Summarize_data_using_HDInsight_Spark.html">Summarize data using HDInsight Spark</a>        </div>
    </div>
    <div class="row">
        <div class="col-md-2 col-md-offset-1 hidden-print">
            <div data-spy="affix" data-offset-top="100">
                <!-- Navigation -->
                <ul class='Nav'><li class='Nav__item '><a href="../Overview.html">Overview</a></li><li class='Nav__item  has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Getting Started</a><ul class='Nav'><li class='Nav__item '><a href="../Getting_Started/Requirements.html">Requirements</a></li><li class='Nav__item '><a href="../Getting_Started/Azure_Registration.html">Azure Registration</a></li><li class='Nav__item '><a href="../Getting_Started/Setup.html">Setup</a></li></ul></li><li class='Nav__item Nav__item--open has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Courseware</a><ul class='Nav'><li class='Nav__item '><a href="../Courseware/Build_a_ML_Model.html">Build a ML Model</a></li><li class='Nav__item '><a href="../Courseware/Setup Azure Data Factory.html">Setup Azure Data Factory</a></li><li class='Nav__item '><a href="../Courseware/Develop_a_data_factory_pipeline_for_data_movement.html">Develop a data factory pipeline for data movement</a></li><li class='Nav__item '><a href="../Courseware/Operationalize_ML_Scoring_with_Azure_ML_and_Data_Factory.html">Operationalize ML Scoring with Azure ML and Data Factory</a></li><li class='Nav__item Nav__item--active'><a href="../Courseware/Summarize_data_using_HDInsight_Spark.html">Summarize data using HDInsight Spark</a></li><li class='Nav__item '><a href="../Courseware/Visualizing_in_PowerBI_Desktop.html">Visualizing in PowerBI Desktop</a></li><li class='Nav__item '><a href="../Courseware/Deploy_Intelligent_Web_App.html">Deploy Intelligent Web App</a></li><li class='Nav__item '><a href="../Courseware/Cleanup.html">Cleanup</a></li></ul></li></ul>
                <div class="Links">
                    
                    <div class="pdf-link">
                        <hr />
                        <a href="../pdf/Big Data and Visualization.pdf"><i class="fa fa-file-pdf-o" aria-hidden="true"></i> <span>Download PDF</span></a>
                    </div>

                                            <hr/>
                        <div class="Twitter">
                                                            <iframe allowtransparency="true" frameborder="0" scrolling="no" style="width:162px; height:20px;" src="https://platform.twitter.com/widgets/follow_button.html?screen_name=azureworkshops&amp;show_count=false"></iframe>
                                <br />
                                <br />
                                                    </div>
                                    </div>
            </div>
        </div>
        <div class="col-md-6">
            <article class="Page">
    <div class="pageHeader">
        <h1>Summarize data using HDInsight Spark</h1>
                    <div class="date"> Friday, August 24, 2018 11:57 AM</div>
            </div>
    <div class="copy">
        <h2 id="page_Exercise-5-Summarize-data-using-HDInsight-Spark"><strong>Exercise 5:</strong> Summarize data using HDInsight Spark</h2>
<p><strong>Duration:</strong> 20 mins</p>
<p><strong>Synopsis:</strong> In this exercise, you will prepare a summary of flight delay data in HDFS using Spark SQL.</p>
<h3 id="page_Task-1-Install-pandas-on-the-HDInsight-cluster"><strong>Task 1:</strong> Install pandas on the HDInsight cluster</h3>
<p>In this task, you will upgrade the version of panda on the HDInsight cluster, to ensure the Jupyter notebook’s autovixwidget has the necessary ‘api’ module installed.</p>
<ol>
<li>
<p>In the Azure portal, navigate to your HDInsight cluster, and from the Overview blade select Secure Shell (SSH).</p>
<img src="../images/hdi_select_secure_shell.jpg" class="block"/>
</li>
<li>
<p>On the SSH + Cluster login blade, select your cluster from the Hostname drop down, then select the copy button next to the SSH command.</p>
<img src="../images/hdi_ssh_copy_cluster_name.jpg" class="block"/>
</li>
<li>
<p>On your Lab VM, open a <strong>new Git Bash terminal</strong> window.</p>
</li>
<li>
<p>At the prompt, paste the SSH command you copied from your HDInsight SSH + Cluster login blade.</p>
<img src="../images/hdi_ssh_git_bash_terminal.jpg" class="block"/>
</li>
<li>
<p>Enter <strong>yes</strong>, if prompted about continuing, and <strong>enter the following password</strong> for the sshuser:</p>
<ul>
<li>Abc!1234567890</li>
</ul>
</li>
<li>
<p>At the sshuser prompt within the bash terminal, <strong>enter the following command</strong> to install pandas on the cluster:</p>
<ul>
<li>sudo -HE /usr/bin/anaconda/bin/conda install pandas</li>
</ul>
</li>
</ol>
<h3 id="page_Task-2-Summarize-delays-by-airport"><strong>Task 2:</strong> Summarize delays by airport</h3>
<ol>
<li>
<p>In the Azure portal (https://portal.azure.com), navigate to the blade for your Spark cluster. Do this by going to the resource group you created during the lab setup, using the Resource Group link in the left-hand menu. Once you select your resource group, you will see a list of the resources within that group, including your Spark cluster. Select your Spark cluster.</p>
<img src="../images/nav_to_spark_cluster.jpg" class="block"/>
</li>
<li>
<p>In the <strong>Quick links</strong> section, select <strong>Cluster dashboard</strong>.</p>
<img src="../images/hdi_select_cluster_dashboard.jpg" class="block"/>
</li>
<li>
<p>From the <strong>Cluster dashboards</strong> blade, select <strong>Jupyter Notebook</strong>.</p>
<img src="../images/hdi_select_jupyter_notebook.jpg" class="block"/>
</li>
<li>
<p>Juptyer Notebook will open in a new browser window. <strong>Log in</strong> with the following credentials:</p>
<ul>
<li>User name: demouser</li>
<li>Password: Password.1!!</li>
<li>Note: If you get a 403 – Forbidden: Access is denied error, try to open the jupyter URL in a private or incognito browser window. You can also clear the browser cache.</li>
</ul>
</li>
<li>
<p>On the Jupyter Notebook screen, select <strong>New</strong>, and <strong>Spark</strong>. This will open a Jupyter notebook in a new browser tab.</p>
<img src="../images/hdi_jupyter_new_spark.jpg" class="block"/>
</li>
<li>
<p><strong>Copy the text below</strong>, and <strong>paste</strong> it into the <strong>first cell</strong> in the Jupyter notebook. This will read the data from our Scored_FlightsAndWeather.csv file, and output it into a Hive table named “FlightDelays.”</p>
</li>
</ol>
<pre><code class="language-python">import spark.sqlContext.implicits._

val flightDelayTextLines = sc.textFile(&quot;/ScoredFlightsAndWeather/*.csv&quot;)

case class AirportFlightDelays(OriginAirportCode:String,OriginLatLong:String,Month:Integer,Day:Integer,Hour:Integer,Carrier:String,DelayPredicted:Integer,DelayProbability:Double)

val flightDelayRowsWithoutHeader = flightDelayTextLines.map(s =&gt; s.split(&quot;,&quot;)).filter(line =&gt; line(0) != &quot;OriginAirportCode&quot;)

val resultDataFrame = flightDelayRowsWithoutHeader.map(
    s =&gt; AirportFlightDelays(
        s(0), //Airport code
        s(13) + &quot;,&quot; + s(14), //Lat,Long
        s(1).toInt, //Month
        s(2).toInt, //Day
        s(3).toInt, //Hour
        s(5), //Carrier
        s(11).toInt, //DelayPredicted
        s(12).toDouble //DelayProbability
        )
).toDF()

resultDataFrame.write.mode(&quot;overwrite&quot;).saveAsTable(&quot;FlightDelays&quot;)

</code></pre>
<ol start="7">
<li>
<p>The notebook should now look like the image below.</p>
<img src="../images/hdi_jupyter_notebook_paste_spark_code.jpg" class="block"/>
</li>
<li>
<p>Select the Run cell button on the toolbar.</p>
<img src="../images/hdi_jupyter_notebook_run_cell.jpg" class="block"/>
</li>
<li>
<p>You will see in asterisk appear between the brackets in front of the cell.</p>
<img src="../images/hdi_jupyter_notebook_asterisk.jpg" class="block"/>
</li>
<li>
<p>This will change to a number once the command is complete.</p>
<img src="../images/hdi_jupyter_notebook_asterisk_to_num.jpg" class="block"/>
</li>
<li>
<p>Below the cell, you will see the output from executing the command.</p>
<img src="../images/hdi_jupyter_notebook_spark_command_output.jpg" class="block"/>
</li>
<li>
<p>Now, we can query the hive table which was created by the previous command. <strong>Paste</strong> the text below into the <strong>empty cell</strong> at the bottom on the notebook, and <strong>select</strong> the <strong>Run cell</strong> button for that cell.</p>
</li>
</ol>
<pre><code class="language-sql">%%sql

SELECT * FROM FlightDelays
</code></pre>
<ol start="13">
<li>
<p>Once completed you will see the results displayed as a table.</p>
<img src="../images/jupyter_hive_query_results_flightdelays.jpg" class="block"/>
</li>
<li>
<p>Next, you will create a table that summarizes the flight delays data. Instead of containing one row per flight, this new summary table will contain one row per origin airport at a given hour, along with a count of the quantity of anticipated delays. In a <strong>new cell</strong> below the results of our previous cell, <strong>paste</strong> the following text, and <strong>select</strong> the <strong>Run cell</strong> button from the toolbar.</p>
</li>
</ol>
<pre><code class="language-sql">%%sql

SELECT  OriginAirportCode, OriginLatLong, Month, Day, Hour, Sum(DelayPredicted) NumDelays, Avg(DelayProbability) AvgDelayProbability 
FROM FlightDelays 
WHERE Month = 4
GROUP BY OriginAirportCode, OriginLatLong, Month, Day, Hour
Having Sum(DelayPredicted) &gt; 1
</code></pre>
<ol start="15">
<li>
<p>Execution of this cell should return a results table like the following.</p>
<img src="../images/jupyter_hive_summarized_results.jpg" class="block"/>
</li>
<li>
<p>Since the summary data looks good, the final step is to save this summary calculation as a table, which we can later query using Power BI (in the next exercise).</p>
</li>
<li>
<p>To accomplish this, <strong>paste</strong> the text below into a <strong>new cell</strong>, and <strong>select</strong> the <strong>Run cell</strong> button from the toolbar.</p>
</li>
</ol>
<pre><code class="language-python">val summary = spark.sqlContext.sql(&quot;SELECT  OriginAirportCode, OriginLatLong, Month, Day, Hour, Sum(DelayPredicted) NumDelays, Avg(DelayProbability) AvgDelayProbability FROM FlightDelays WHERE Month = 4 GROUP BY OriginAirportCode, OriginLatLong, Month, Day, Hour Having Sum(DelayPredicted) &gt; 1&quot;)
summary.write.mode(&quot;overwrite&quot;).saveAsTable(&quot;FlightDelaysSummary&quot;)
</code></pre>
<ol start="18">
<li>To verify the table was successfully created, go to another <strong>new cell</strong>, and <strong>enter the following query</strong>.</li>
</ol>
<pre><code class="language-sql">%%sql

SELECT * FROM FlightDelaysSummary

</code></pre>
<ol start="19">
<li>
<p>Select the Run cell button on the toolbar.</p>
<img src="../images/hdi_jupyter_notebook_run_cell.jpg" class="block"/>
</li>
<li>
<p>You should see a results table similar to the following.</p>
</li>
</ol>
   <img src="../images/jupyter_results_flightdelaysummary.jpg" class="block"/>
21.	You can also select Pie, Scatter, Line, Area, and Bar chart visualizations of the dataset.
    </div>

            <nav class="hidden-print">
            <ul class="pager">
                                    <li class=pager-prev><a href="../Courseware/Operationalize_ML_Scoring_with_Azure_ML_and_Data_Factory.html">Previous</a></li>
                                                    <li class=pager-next><a href="../Courseware/Visualizing_in_PowerBI_Desktop.html">Next</a></li>            </ul>
        </nav>
    </article>
        </div>
        <div class="col-md-2 hidden-print">
            <div class="article-links" data-spy="affix" data-offset-top="100">
                
            </div>
        </div>
    </div>
</div>

    <div id="footer" class="container-fluid hidden-print">
        <div class="row">
            <div class="col-md-2 col-md-offset-1">
            
            </div>
            <div class="col-md-8" style="text-align:right;">
            This work is licensed under a Creative Commons Attribution 4.0 International License.
            </div>
        </div>
    </div>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- JS -->
    
    <script src="../themes/azure/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="../themes/azure/js/theme.js"></script>

</body>
</html>
